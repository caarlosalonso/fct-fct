<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" sizes="32x32" href="https://site.educa.madrid.org/ies.arquitectoventurarodriguez.boadilla//wp-content/uploads/ies.arquitectoventurarodriguez.boadilla/2023/05/cropped-logo-ventura-rodriguez.jpg">
    <link rel="icon" type="image/x-icon" href="https://site.educa.madrid.org/ies.arquitectoventurarodriguez.boadilla//wp-content/uploads/ies.arquitectoventurarodriguez.boadilla/2023/05/cropped-logo-ventura-rodriguez.jpg">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">
    <link rel="stylesheet" href="/styles/global.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js" integrity="sha384-j1CDi7MgGQ12Z7Qab0qlWQ/Qqz24Gc6BM0thvEMVjHnfYGF0rmFCozFSxQBxwHKO" crossorigin="anonymous"></script>
    <script type="module" src="/scripts/global.js"></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subir Archivo</title>
</head>
<body>
    <form id="alumno-form" method="POST" submit-text="Subir fichero" enctype="multipart/form-data">
        <div id="inputs" class="form-container">
            <div class="instance form-input grouped-inputs">
                <div class="form-group form-input">
                    <input type="file" name="archivo" id="archivo" class="input" label="Archivo" required="true">
                </div>
            </div>
        </div>
    </form>
</body>
</html>

<script type="module">
    // Import and configure Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";
    const storage = getStorage();

    document.addEventListener('FormsCreated', (event) => {
        const form = Form.getForm('alumno-form');
        
            form.onsubmit = async function (event) {
                const FormData = new FormData(event.target);
            
                const archivo = form.getInput('archivo').getValue();

                const file = fileInput.files[0];

                const data = new FormData();
                data.append('file', file);

                // Crear una referencia al archivo en Firebase
                const storageRef = ref(storage, 'uploads/' + file.name);

                // Subir el archivo a Firebase
                uploadBytes(storageRef, file).then((snapshot) => {
                    console.log('Uploaded file!');

                // Obtener el URL de descarga del archivo
                getDownloadURL(storageRef).then((url) => {
                    console.log('File available at', url);
                });
                });

                try {
                    const res = await fetch('/api/ficheros/subir', {
                    method: 'POST',
                    credentials: 'include', // si usas sesión
                    body: data
                });
                    if (!res.ok) {
                        const err = await res.json();
                        alert('Error: ' + (err.error || res.statusText));
                            return;
                }
                    const json = await res.json();
                    alert(json.mensaje); // “Archivo subido correctamente”
                } catch (err) {
                    alert('Error al subir el archivo: ' + err.message);
                }
        }
    });


    
</script>